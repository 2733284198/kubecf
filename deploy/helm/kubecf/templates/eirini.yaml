{{- define "kubecf.imagePullSecret" }}
  {{- if .Values.eirini.opi.use_registry_ingress }}
    {{- printf "{\"auths\": {\"registry.%s\": {\"auth\": \"%s\"}}}" .Values.eirini.opi.ingress_endpoint (printf "admin:%s" .Values.bits.secrets.BITS_SERVICE_SIGNING_USER_PASSWORD | b64enc) | b64enc }}
  {{- else if .Values.eirini.services.loadbalanced }}
    {{- printf "{\"auths\": {\"registry.%s\": {\"auth\": \"%s\"}}}" .Values.system_domain (printf "admin:%s" .Values.bits.secrets.BITS_SERVICE_SIGNING_USER_PASSWORD | b64enc) | b64enc }}
  {{- else }}
    {{- printf "{\"auths\": {\"registry.%s.nip.io\": {\"auth\": \"%s\"}}}" index .Values.kube.external_ips 0 (printf "admin:%s" .Values.bits.secrets.BITS_SERVICE_SIGNING_USER_PASSWORD | b64enc) | b64enc }}
  {{- end }}
{{- end }}

# Create the bits secret
{{- if .Values.features.eirini.use_helm_release }}
---
apiVersion: quarks.cloudfoundry.org/v1alpha1
kind: QuarksSecret
metadata:
  name: bits-service-ssl
spec:
  request:
    certificate:
      alternativeNames:
      {{- if .Values.eirini.opi.use_registry_ingress }}
      - "registry.{{ .Values.eirini.opi.ingress_endpoint }}"
      {{- else if .Values.eirini.services.loadbalanced }}
      - "registry.{{ .Values.system_domain }}"
      {{- else }}
      - "registry.{{ index .Values.kube.external_ips 0 }}.nip.io"
      {{- end }}
      commonName: bits
      isCA: false
      signerType: cluster
  secretName: bits-service-ssl
  type: certificate
---
apiVersion: v1
kind: Secret
metadata:
  name: registry-secret-name
  namespace: {{ .Values.eirini.opi.namespace }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ template "kubecf.imagePullSecret" . }}

---  
apiVersion: v1
kind: Secret
metadata:
  labels:
    quarks.cloudfoundry.org/secret-kind: generated
  annotations:
    quarks.cloudfoundry.org/secret-copy-of: {{ .Release.Namespace }}/var-eirini-tls-client-cert
  name: var-eirini-tls-client-cert
  namespace: {{ .Values.eirini.opi.namespace | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    quarks.cloudfoundry.org/secret-kind: generated
  annotations:
    quarks.cloudfoundry.org/secret-copy-of: {{ .Release.Namespace }}/var-cc-bridge-cc-uploader
  name: var-cc-bridge-cc-uploader
  namespace: {{ .Values.eirini.opi.namespace | quote }}
{{- end }}
